# АнтифриЗ

<!-- markdownlint-disable-next-line MD033 -->
<img src="logo.png" alt="MetricZ" align="right" width="380">

Серверный мод для DayZ.
Снижает нагрузку на CPU, когда у зомби нет шансов достать игрока за препятствием или на высоте.
Проект сделан как эксперимент, чтобы разобраться с просадками серверного FPS в сценах, где зомби упираются в двери/стены и продолжают тратить тики ИИ.
Описание проблемы: [T195642](https://feedback.bistudio.com/T195642)

В теории я ожидаю, что если на сервере к примеру ~60 человек в онлайне, и ~20 человек из них активно сражаются с 5-10 зомби каждый (используя тактику залезания на возвышенности или сражаясь с зомби через окна).
Такая ситуация суммарно в пике может дать одновременно 100-200 зомби находящихся в дорогом цикличном поиске игрока.
Это лишь эксперимент, и нет никаких гарантий, что это реально поможет вам и вашему серверу в обычных игровых ситуациях.
Но если вы хотите реализовать орды зомби преследующие игрока, это должно дать положительный эффект.

## Как работает

Зомби рядом с игроком ведут себя как в ваниле.
Далёкие зомби переключаются на короткие подходы по очереди, чтобы не нагружать сервер всем скопом.
Если игрок близко по горизонтали, но заметно выше, ИИ временно делает паузы и периодически проверяет, не стала ли цель доступной. При сильной скученности часть зомби уходит в паузу, чтобы убрать толкотню и пики расчётов.

Логика чисто серверная, клиентского кода нет.
Поведение боёвки, урон, лут и спавн не изменяются.
Встроена горячая перезагрузка конфига через чат-команду.
Точки интеграции минимальны: расширен только `ZombieBase` и небольшая правка `MissionServer::OnEvent` для поддержки команды перезапуска конфига.

> [!IMPORTANT]  
> Это не серебренная пуля которая обязательно поднимет FPS вашего сервера, есть еще куча других факторов которые влияют на производительность, особенно если вы используете множество разных модификаций.
> Я не гарантирую что именно в вашем сценарии это реально поможет, также возможно что зомби станут глупее или будут вести себя не так как вы привыкли в ванили.  

## Установка и настройка

Скопируй мод в папку сервера, например в @antifreeze.
Запускай сервер с параметром `-serverMod=@antifreeze`.
Конфиг создастся автоматически в `$profile/antifreeze.json` при первом старте.

Подробнее о параметрах `antifreeze.json` можно [прочитать тут](CONFIG.ru.md)

Для горячей перезагрузки конфига должен быть включен `enableHotConfigReload` и отправь в чат`afz-reload` (без слеша).

## Совместимость

Мод переопределяет поведение в `class ZombieBase`, основные изменения выполнены в `CommandHandler`.
Если другие моды патчат те же методы, учитывай порядок загрузки: чтобы логика AntifreeZe имела приоритет.

> [!NOTE]  
> Мод не правит навмеш и геометрию карты и не лечит ванильные баги, он только уменьшает их стоимость по CPU. Давление толпы возможно, но просчёты дешевле.

## Известные проблемы

* Зомби могут преследовать игрока почти вечно.

## Анализ

Для анализа работы модификации лучше всего использовать механизмы сбора метрик, к примеру в формате prometheus может подойти такая модификация как [MetricZ](https://github.com/WoozyMasta/metricz).
Так вы точно на графиках сможете увидеть корреляцию между FPS, активными игроками, количеством зомби и их состояние ума.
Вы конечно можете использовать параметр сервера `-doLogs` и анализировать журнал и записи о текущем FPS, но это менее информативно.
