<!-- markdownlint-disable-next-line MD033 MD041 -->
<img src="logo.png" alt="MetricZ" align="right" width="260">

# АнтифриЗ: конфигурация

## Параметры

### Выключатели

* `enableAntifreeze` (bool)
  * **Назначение**: главный выключатель всего механизма "паузы мыслей" у зомби, чтобы разгрузить CPU.
  * **Что делает**: 0 — мод выключен полностью. 1 — мод работает.
  * **Геймплей**: 0 — ваниль. 1 — дальние зомби берут "паузу", близкие работают как обычно.
  * **Производительность**: 1 экономит CPU, особенно при толпах.
  * **Рекомендуемо**: 1
  * **Диапазон**: {0,1}

* `enableFreezeUnreachableByHeight` (bool)
  * **Назначение**: если игрок рядом по горизонтали, но заметно выше (например, на крыше), зомби перестают суетится в пустую каждый кадр сервера и берут паузы.
  * **Что делает**: отслеживает разницу по высоте и дистанцию. Если слишком высоко — временно замораживает логику зомби.
  * **Геймплей**: меньше бесполезных попыток у препятствий, зомби успокаиваются, пока ситуация не изменится.
  * **Производительность**: снижает дорогие проверки проходимости около вертикальных препятствий.
  * **Рекомендуемо**: 1
  * **Диапазон**: {0,1}

* `enableChaseTokenBudget` (bool)
  * **Назначение**: когда зомби далеко от игрока, они бегут по очереди, а не все разом. Ближайшие всегда активны.
  * **Как понимать**: представь ближний круг вокруг игрока. Вне этого круга зомби периодически просыпаются небольшими порциями и пробегают чуть-чуть, потом снова стают в очередь.
  * **Геймплей**: меньше одновременных рывков издалека, подходы идут волнами. Возле игрока поведение нормальное.
  * **Производительность**: резко снижает пиковую нагрузку при массовых стаях.
  * **Рекомендуемо**: 1
  * **Диапазон**: {0,1}

* `enableLocalDensityCulling` (bool)
  * **Назначение**: если вокруг слишком много зомби, лишних временно замораживает. Меньше толкотни и застреваний.
  * **Геймплей**: меньше стен из зомби, атаки становятся очередями.
  * **Производительность**: меньше коллизий и просчетов пути одновременно.
  * **Рекомендуемо**: 1
  * **Диапазон**: {0,1}

* `enableRandomJitter` (bool)
  * **Назначение**: добавляет случайную задержку к таймерам, чтобы зомби не просыпались одной волной в один кадр.
  * **Геймплей**: незаметно.
  * **Производительность**: сглаживает микрофризы.
  * **Рекомендуемо**: 1
  * **Диапазон**: {0,1}

* `enableCheapAttackProbe` (bool)
  * **Назначение**: дополнительная быстрая проверка - можно ли вообще ударить туда, где игрок сейчас.
  * **Геймплей**: зомби чуть быстрее сдаются в плохих местах.
  * **Производительность**: меньше бесполезной логики боя.
  * **Рекомендуемо**: 0 (включать только если знаешь, что делаешь)
  * **Диапазон**: {0,1}
  * **Риск**: редкие ложные срабатывания на кривых навмешах.

* `enableFrozenAgingTicks` (bool)
  * **Назначение**: даже когда зомби на паузе, иногда им дают кадр для внутренних таймеров, чтобы они не зависали намертво.
  * **Геймплей**: замороженные корректнее остывают, и не зависают навсегда (но это не точно, остывание бывает длинным, горазд длинее ванили).
  * **Производительность**: небольшой расход ради стабильности.
  * **Рекомендуемо**: 1
  * **Диапазон**: {0,1}

* `enableRandomPerZombieOptOut` (bool)
  * **Назначение**: часть зомби полностью игнорирует мод и живет по ванили.
  * **Для чего**: A/B-тест, смешанное поведение для сравнения. Можно к примеру 15% от всех зомби сделать ванильными, если замечаете, что модифицированные более глупые с вашими настройками.
  * **Производительность**: ухудшает экономию, см. `randomOptOutRatio`.
  * **Рекомендуемо**: 0
  * **Диапазон**: {0,1}

* `enableForceCleanupBodies` (bool)
  * **Назначение**: принудительное удаление тел мертвых зараженных, но трупы смогут исчезать на глазах у игрока.
  * **Для чего**: по умолчанию центральная экономика (`globals.xml`) игры удаляет трупы зомби по истечению`CleanupLifetimeDeadInfected` времени, но при условии что в радиусе `CleanupAvoidance` нет игроков, включив эту опцию `CleanupAvoidance` будет проигнорирован, а также дополнительно можно переопределить `CleanupLifetimeDeadInfected` при помощи опции `cleanupBodiesTTL`.
  * **Производительность**: может немного улучшить производительность, когда игроки очень долго удерживают одну точку и не позволяют исчезать трупам.
  * **Рекомендуемо**: 1
  * **Диапазон**: {0,1}

* `enableHotConfigReload` (bool)
  * **Назначение**: разрешает выполнять команду `afz-reload` для горячей перезагрузки конфигурационного файла.
  * **Обрати внимание**: эта команда доступна любому игроку, и включив эту опцию, любой кто напишет в чат `afz-reload` запустит повторное чтение конфига, ничего страшного не произойдет, но просто знай это и используй это только для начальной настройки модификации.
  * **Особенности**: горячая перезагрузка не повлияет на некоторые параметры которые вычисляются один раз при создании зомби, для этих опций вам нужно будет после перезагрузки конфигурации создать новых существ. Список затрагиваемых опций:
    * `enableRandomJitter` и параметр `frozenProbeJitterSeconds`
    * `enableRandomPerZombieOptOut` и параметр `randomOptOutRatio`
  * **Рекомендуемо**: 0
  * **Диапазон**: {0,1}

### Основная синхронизация

* `unreachablePersistSeconds` (float)
  * **Назначение**: сколько секунд подряд зомби должны видеть, что игрок слишком высоко, прежде чем взять паузу.
  * **Геймплей**: значение больше — дольше ждут игрока, меньше — быстрее успокаиваются.
  * **Производительность**: чем меньше, тем больше экономит ресурсов.
  * **По умолчанию**: 0.6
  * **Диапазон**: 0.05..5.0

* `frozenProbeBaseIntervalSeconds` (float)
  * **Назначение**: базовая пауза между проверками "а можно ли уже бежать снова" для замороженного зомби.
  * **Геймплей**: меньше — быстрее просыпаются, больше — дольше спят.
  * **Производительность**: больше — лучше экономит ресурсы.
  * **По умолчанию**: 0.5
  * **Диапазон**: 0.05..10.0

* `frozenProbeJitterSeconds` (float)
  * **Назначение**: случайная добавка к предыдущему интервалу, чтобы зомби не просыпались ровно вместе.
  * **По умолчанию**: 0.35
  * **Диапазон**: 0.0..5.0

* `throttleBaseIntervalSeconds` (float)
  * **Назначение**: базовая пауза для дальних зомби, когда не их очередь использовать текущий ход.
  * **Геймплей**: больше — дальние зомби подходят медленнее, волнами.
  * **Производительность**: больше — лучше экономит ресурсы.
  * **По умолчанию**: 0.45
  * **Диапазон**: 0.05..10.0

* `throttleJitterSeconds` (float)
  * **Назначение**: случайная добавка к предыдущей `throttleBaseIntervalSeconds` паузе, чтобы волны не совпадали.
  * **По умолчанию**: 0.35
  * **Диапазон**: 0.0..10.0

### Разморозка

* `frozenAgingTickInterval` (float)
  * **Назначение**: как часто давать короткий тик замороженному зомби.
  * **Геймплей**: больше — замороженные дольше спят без обновлений.
  * **Производительность**: больше — лучше экономит ресурсы.
  * **По умолчанию**: 0.75
  * **Диапазон**: 0.25..5.0

* `frozenAgingTickDtCap` (float)
  * **Назначение**: ограничение на вес одного такого `frozenAgingTickInterval` тика, чтобы он не был слишком дорогим.
  * **По умолчанию**: 0.06
  * **Диапазон**: 0.01..0.20

### Пространственные пороги

* `unreachableHeightDeltaMeters` (float)
  * **Назначение**: на сколько метров игрок должен быть выше зомби, чтобы считать что он слишком высоко.
  * **Геймплей**: чем меньше — быстрее сдаются при невысоких препятствиях.
  * **Производительность**: меньше — лучше экономит ресурсы.
  * **По умолчанию**: 1.25
  * **Диапазон**: 0.10..12.0

* `nearRadiusMeters` (float)
  * **Назначение**: радиус близких зомби, в пределах которого `unreachableHeightDeltaMeters` проверка высоты не имеет смысл.
  * **Геймплей**: больше — чаще ловит случаи когда игрок слишком высоко.
  * **Производительность**: больше — лучше экономит ресурсы рядом с препятствиями.
  * **По умолчанию**: 6.0
  * **Диапазон**: 0.50..20.0

* `activeRingRadiusMeters` (float)
  * **Назначение**: радиус ближнего круга вокруг игрока. Внутри круга зомби не ставятся "в очередь", а работают как обычно.
  * **Геймплей**: больше — ближние реагируют стабильнее; меньше — чуть больше экономии, но могут быть рывки рядом с игроком.
  * **Производительность**: меньше — лучше экономит ресурсы.
  * **По умолчанию**: 4.5
  * **Диапазон**: 1.0..16.0

* `densityWindowRadiusMeters` (float)
  * **Назначение**: радиус области, в котором считаем сколько зомби в куче.
  * **Геймплей**: больше — толпы чаще разбираются по очереди.
  * **Производительность**: больше — меньше одновременных коллизий.
  * **По умолчанию**: 2.0
  * **Диапазон**: 0.5..10.0

* `densityMaxNeighbors` (int)
  * **Назначение**: если в радиусе `densityWindowRadiusMeters` найдено столько или больше живых зомби — часть берут паузу.
  * **Геймплей**: меньше — меньше "стен" из зомби, но не делайте слишком маленькие значения.
  * **Производительность**: меньше — лучше экономит ресурсы.
  * **По умолчанию**: 6
  * **Диапазон**: 0..64

### Преследование

* `chaseTokenTTLSeconds` (float)
  * **Назначение**: как долго "дальний" зомби активен, когда до него дошла очередь.
  * **Образно**: его ход будет длится столько-то секунд.
  * **Геймплей**: больше — волны длиннее, подходят плотнее, меньше — шаги короче.
  * **Производительность**: больше — дороже пот ресурсам.
  * **По умолчанию**: 1.2
  * **Диапазон**: 0.05..10.0

* `chaseTokenTTLJitterSeconds` (float)
  * **Назначение**: случайная добавка к `chaseTokenTTLSeconds` времени хода, чтобы волны не совпадали идеально.
  * **По умолчанию**: 0.5
  * **Диапазон**: 0.0..5.0

* `chaseKeepBaseProbability` (float)
  * **Назначение**: чем зомби ближе к ближнему кругу, тем чаще им дают шанс пробежать, но верх/низ ограничены. Итоговый шанс выдать ход = `chaseKeepBaseProbability * (nearRadiusMeters / distance)`, затем ограничение между min и max.
  * **Геймплей**: больше — больше дальних зомби одновременно двигаются.
  * **Производительность**: меньше — лучше экономит ресурсы.
  * **По умолчанию**: 0.25
  * **Диапазон**: 0.0..1.0

* `chaseKeepMinProbability` (float)
  * **Назначение**: нижняя граница `chaseKeepBaseProbability` шанса. Даже очень далеким иногда дают ход.
  * **Геймплей**: больше — гарантированно будут редкие подбросы даже издалека.
  * **Производительность**: меньше — лучше экономит ресурсы.
  * **По умолчанию**: 0.04
  * **Диапазон**: 0.0..1.0

* `chaseKeepMaxProbability` (float)
  * **Назначение**: верхняя граница `chaseKeepBaseProbability` шанса. Не даёт всем сразу, даже если они почти рядом, но вне ближнего круга.
  * **Геймплей**: меньше — меньше массовых рывков.
  * **Производительность**: меньше — лучше экономит ресурсы.
  * **По умолчанию**: 0.55
  * **Диапазон**: 0.0..1.0

### Принудительное пробуждение

* `wakeGraceSeconds` (float)
  * **Назначение**: после удара по зомби или контакта с зомби (транспорт), он не ставится на паузу некоторое время. Бой остаётся отзывчивым.
  * **Геймплей**: больше — меньше странных пауз в драке.
  * **Производительность**: больше — чуть дороже в момент боя.
  * **По умолчанию**: 3.0
  * **Диапазон**: 0.10..10.0

* `wakeCooldownSeconds` (float)
  * **Назначение**: защита от слишком частых пробуждений подряд. Между такими событиями выдерживается пауза.
  * **Геймплей**: слишком большое значение — зомби чуть медленнее доразгоняются при частом пинге.
  * **Производительность**: выше — меньше спама событий.
  * **По умолчанию**: 0.30
  * **Диапазон**: 0.10..10.0

### Прочее

* `randomOptOutRatio` (float)
  * **Назначение**: доля зомби, которые полностью игнорируют мод (живут ванилью) весь свой жизненный цикл.
  * **Геймплей**: смешанное поведение.
  * **Производительность**: чем больше, тем меньше экономии.
  * **По умолчанию**: 0.0
  * **Диапазон**: 0.0..0.9

* `cleanupBodiesTTL` (int)
  * **Назначение**: переопределение глобальной опции `CleanupLifetimeDeadInfected`.
  * **По умолчанию**: равно `CleanupLifetimeDeadInfected`
  * **Диапазон**: 0..`CleanupLifetimeDeadInfected`

* `version` (int, не редактируй)
  * **Назначение**: версия структуры файла. Мод обновляет сам, менять не нужно.

## Как это работает в 2 фразах

1. Ближний к игроку радиус содержит зомби которые всегда активны.
2. Внешний радиус содержит оптимизированных зомби, они делают свои шаги по очереди короткими подходами. Если игрок слишком высоко — зомби берут паузы и не жрут CPU впустую.

## Рецепты настройки по симптомам

### FPS падает, когда игрок привёл большую стаю издалека

* Подними `throttleBaseIntervalSeconds` до 0.6–0.9
* Понизь `chaseKeepBaseProbability` до 0.18–0.22
* Понизь `chaseKeepMaxProbability` до 0.45–0.50
* Оставь `activeRingRadiusMeters` в 4.5–5.0

### Зомби подходят слишком медленно

* Подними `chaseKeepBaseProbability` до 0.30–0.35
* Подними `chaseTokenTTLSeconds` до 1.5–1.8
* Понизь `throttleBaseIntervalSeconds` до 0.30–0.40
* Чуть подними `activeRingRadiusMeters` до 5.0–5.5

### Стены из зомби у дверей/проходов

* Понизь `densityMaxNeighbors` до 4–5
* Подними `densityWindowRadiusMeters` до 2.5–3.0

### Игроки часто сидят на высоте (крыши/маины/мусорки), зомби толпятся под ними

* Подними `unreachablePersistSeconds` до 0.8–1.0 (быстрее уходят на паузу)
* Понизь `unreachableHeightDeltaMeters` до 1.0–1.1 (легче признают цель "слишком высоко")

### Микростаттеры при одновременных просыпаниях

* Убедись `enableRandomJitter` = 1
* Подними `frozenProbeJitterSeconds` и/или `throttleJitterSeconds` на +0.1..0.2

## Связи параметров

* Чем больше `chaseTokenTTLSeconds`, тем логичнее чуть увеличить `throttleBaseIntervalSeconds`, чтобы волны не наслаивались.
* Чем больше `activeRingRadiusMeters`, тем можно уменьшить `chaseKeepBaseProbability`: близкие и так не ограничиваются.
* `nearRadiusMeters` входит в формулу шанса "chaseKeep": больше радиус -> на тех же дистанциях шанс выше.
* `densityWindowRadiusMeters` больше при неизменном `densityMaxNeighbors` уменьшает шансы на "пробки" и "стены".
* `unreachableHeightDeltaMeters` и `unreachablePersistSeconds` вместе формируют, как быстро зомби "сдаются" при вертикальных препятствиях.

## Практика: стартовые профили

### Баланс (дефолт)

* `throttleBaseIntervalSeconds`=0.45
* `throttleJitterSeconds`=0.35
* `chaseKeepBaseProbability`=0.25
* `chaseTokenTTLSeconds`=1.2
* `activeRingRadiusMeters`=4.5
* `densityMaxNeighbors`=6

### Больше экономии (низкие ПК/сервер на коленке)

* `throttleBaseIntervalSeconds`=0.8
* `throttleJitterSeconds`=0.5
* `chaseKeepBaseProbability`=0.18
* `chaseKeepMaxProbability`=0.48
* `chaseTokenTTLSeconds`=1.0
* `activeRingRadiusMeters`=4.5
* `densityMaxNeighbors`=4

### Более агрессивно (меньше пауз, больше давления)

* `throttleBaseIntervalSeconds`=0.3
* `throttleJitterSeconds`=0.2
* `chaseKeepBaseProbability`=0.35
* `chaseTokenTTLSeconds`=1.8
* `activeRingRadiusMeters`=5.5
* `densityMaxNeighbors`=7

## Формат файла и обслуживание

* Расположение `$profile/antifreeze.json`
* Булевы 0/1
* Метры и секунды — числа с точкой.
* Не трогать: `version` мод перезапишет.
* Перезагрузка конфига без рестарта: в серверный чат отправь "afzr` (точно так, без слеша). Мод перезагрузит и залогирует.
* Пример [antifreeze.json](antifreeze.json) (сбалансированный)
